#!/bin/bash
#
#  Copyright (c) 2018, The OpenThread Authors.
#  All rights reserved.
#
#  Redistribution and use in source and binary forms, with or without
#  modification, are permitted provided that the following conditions are met:
#  1. Redistributions of source code must retain the above copyright
#     notice, this list of conditions and the following disclaimer.
#  2. Redistributions in binary form must reproduce the above copyright
#     notice, this list of conditions and the following disclaimer in the
#     documentation and/or other materials provided with the distribution.
#  3. Neither the name of the copyright holder nor the
#     names of its contributors may be used to endorse or promote products
#     derived from this software without specific prior written permission.
#
#  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
#  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
#  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
#  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
#  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
#  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
#  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
#  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
#  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
#  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
#  POSSIBILITY OF SUCH DAMAGE.
#

set -e
set -x


#######################################
# Prepare android build system
# Globals:
#   None
# Arguments:
#   None
# Returns:
#   None
#######################################
prepare_build_system()
{
    # Android build system
    BASE_COMMIT=2db32730e79cafcf13e1f898a7bee7f82b0449d6
    # This is the commit containing arm64 target
    ARM64_COMMIT=4f0eb7d50c5b472be762c581eeda580a9b8ede1b
    (mkdir build && cd build && git init && git pull --depth 1 https://android.googlesource.com/platform/build "${BASE_COMMIT}")
    (mkdir build-arm64 && cd build-arm64 && git init && git pull --depth 1 https://android.googlesource.com/platform/build "${ARM64_COMMIT}")
    cp -vr build-arm64/core/combo/TARGET_linux-arm64.mk build/core/combo
    cp -vr build-arm64/core/combo/arch/arm64 build/core/combo/arch
    cp -vr build-arm64/target/board/generic_arm64 build/target/board
    cp -vr build-arm64/target/product/aosp_arm64.mk build/target/product
    sed -i 's/vbox_x86.mk/aosp_arm64.mk/g' build/target/product/AndroidProducts.mk
    sed -i 's/aosp_base_telephony/generic_no_telephony/g;/device.mk/d;/emulator.mk/d' build/target/product/aosp_arm64.mk
    sed -i 's/PRIVATE_TARGET_CRTBEGIN_DYNAMIC_O/TARGET_CRTBEGIN_DYNAMIC_O/g;s/PRIVATE_TARGET_GLOBAL_LD_DIRS/TARGET_GLOBAL_LD_DIRS/g' build/core/combo/TARGET_linux-arm64.mk
    rm -rf build-arm64

    ln -s build/core/main.mk Makefile

    # Workarounds for java checking
    export ANDROID_JAVA_HOME=/usr/lib/jvm/java-8-oracle
    mkdir bin
    cat > bin/java <<EOF
#!/bin/sh
echo java version \"1.6\"
EOF

    cat > bin/javac <<EOF
echo javac \"1.6\"
EOF
    chmod a+x bin/java bin/javac
    export PATH=$(pwd)/bin:$PATH

    # Files for building ndk
    mkdir -p system/core/include/arch/linux-arm64
    touch system/core/include/arch/linux-arm64/AndroidConfig.h

    mkdir -p system/core/include/arch/linux-x86
    touch system/core/include/arch/linux-x86/AndroidConfig.h

    ANDROID_NDK_PATH=$HOME/ndk-bundle
    mkdir -p bionic/libc/
    cp -r $ANDROID_NDK_PATH/sysroot/usr/include bionic/libc/include
    mkdir -p bionic/libc/arch-arm64
    mv bionic/libc/include/aarch64-linux-android bionic/libc/arch-arm64/include

    mkdir -p out/target/product/generic_arm64/obj/
    cp -r $ANDROID_NDK_PATH/platforms/android-27/arch-arm64/usr/lib out/target/product/generic_arm64/obj/

    mkdir -p bionic/libstdc++
    cp -r $ANDROID_NDK_PATH/sources/cxx-stl/gnu-libstdc++/4.9/include bionic/libstdc++
    cp -r $ANDROID_NDK_PATH/sources/cxx-stl/gnu-libstdc++/4.9/libs/arm64-v8a/include/* bionic/libstdc++/include
    # The default libstdc++.so does not contain full stl implementation, see https://developer.android.com/ndk/guides/cpp-support
    cp -r $ANDROID_NDK_PATH/sources/cxx-stl/gnu-libstdc++/4.9/libs/arm64-v8a/libgnustl_shared.so out/target/product/generic_arm64/obj/lib/libstdc++.so

    # Build spec
    cat > buildspec.mk <<EOF
TARGET_PRODUCT := aosp_arm64
TARGET_BUILD_VARIANT := eng
TARGET_BUILD_TYPE := release
TARGET_TOOLS_PREFIX := $ANDROID_NDK_PATH/toolchains/aarch64-linux-android-4.9/prebuilt/linux-x86_64/bin/aarch64-linux-android-
EOF
}

#######################################
# Prepare dbus source code
# Globals:
#   None
# Arguments:
#   None
# Returns:
#   None
#######################################
prepare_dbus()
{
    DBUS_SOURCE=dbus-1.4.26
    wget "https://dbus.freedesktop.org/releases/dbus/${DBUS_SOURCE}.tar.gz"
    tar xvf "${DBUS_SOURCE}.tar.gz"
    (cd "${DBUS_SOURCE}" && ./configure --prefix= --exec-prefix=/usr && sed -i '/HAVE_BACKTRACE/d' config.h)
    cat > "${DBUS_SOURCE}/dbus/Android.mk" <<EOF
LOCAL_PATH:= \$(call my-dir)
include \$(CLEAR_VARS)

LOCAL_SRC_FILES := \
    dbus-address.c \
    dbus-auth.c \
    dbus-auth-script.c \
    dbus-auth-util.c \
    dbus-bus.c \
    dbus-connection.c \
    dbus-credentials.c \
    dbus-credentials-util.c \
    dbus-dataslot.c \
    dbus-errors.c \
    dbus-file.c \
    dbus-file-unix.c \
    dbus-hash.c \
    dbus-internals.c \
    dbus-keyring.c \
    dbus-list.c \
    dbus-mainloop.c \
    dbus-marshal-basic.c \
    dbus-marshal-byteswap.c \
    dbus-marshal-byteswap-util.c \
    dbus-marshal-header.c \
    dbus-marshal-recursive.c \
    dbus-marshal-recursive-util.c \
    dbus-marshal-validate.c \
    dbus-marshal-validate-util.c \
    dbus-memory.c \
    dbus-mempool.c \
    dbus-message.c \
    dbus-message-factory.c \
    dbus-message-util.c \
    dbus-misc.c \
    dbus-nonce.c \
    dbus-object-tree.c \
    dbus-pending-call.c \
    dbus-pipe.c \
    dbus-pipe-unix.c \
    dbus-resources.c \
    dbus-server.c \
    dbus-server-debug-pipe.c \
    dbus-server-launchd.c \
    dbus-server-socket.c \
    dbus-server-unix.c \
    dbus-sha.c \
    dbus-shell.c \
    dbus-signature.c \
    dbus-spawn.c \
    dbus-string.c \
    dbus-string-util.c \
    dbus-sysdeps.c \
    dbus-sysdeps-pthread.c \
    dbus-sysdeps-unix.c \
    dbus-sysdeps-util.c \
    dbus-sysdeps-util-unix.c \
    dbus-test.c \
    dbus-test-main.c \
    dbus-threads.c \
    dbus-timeout.c \
    dbus-transport.c \
    dbus-transport-socket.c \
    dbus-transport-unix.c \
    dbus-userdb.c \
    dbus-userdb-util.c \
    dbus-uuidgen.c \
    dbus-watch.c \
    sd-daemon.c \
    \$(NULL)

\$(DBUS_SOURCES:\$(LOCAL_PATH)/%=%)

LOCAL_C_INCLUDES+= \$(LOCAL_PATH)/..

LOCAL_MODULE:=libdbus

DBUS_HEADERS := \$(wildcard \$(LOCAL_PATH)/*.h)
LOCAL_COPY_HEADERS := \$(DBUS_HEADERS:\$(LOCAL_PATH)/%=%)

LOCAL_COPY_HEADERS_TO := dbus

LOCAL_CFLAGS+= \
    -DDBUS_COMPILATION \
    -DHAVE_MONOTONIC_CLOCK \
    -DDBUS_MACHINE_UUID_FILE=\"/etc/machine-id\" \
    -DDBUS_SYSTEM_CONFIG_FILE=\"/etc/dbus-1/system.conf\" \
    -DDBUS_SESSION_CONFIG_FILE=\"/etc/dbus-1/session.conf\" \
    -Wno-empty-body \
    -Wno-missing-field-initializers \
    -Wno-pointer-sign \
    -Wno-sign-compare \
    -Wno-tautological-compare \
    -Wno-type-limits \
    -Wno-unused-parameter

include \$(BUILD_SHARED_LIBRARY)
EOF
}

#######################################
# Check build with android build system
# Globals:
#   None
# Arguments:
#   None
# Returns:
#   None
#######################################
main()
{
    prepare_build_system
    prepare_dbus

    make showcommands wpanctl
    make showcommands wpantund

    test -f out/target/product/generic_arm64/system/bin/wpanctl
    test -f out/target/product/generic_arm64/system/bin/wpantund
}

main "$@"
